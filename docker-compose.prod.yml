version: '3.8'

services:
    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: bucket-postgres-prod
        environment:
            POSTGRES_USER: ${DB_USER}
            POSTGRES_PASSWORD: ${DB_PASS}
            POSTGRES_DB: ${DB_NAME}
        ports:
            - '127.0.0.1:5432:5432'
        volumes:
            - postgres_data_prod:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${DB_USER}']
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - bucket-network-prod
        restart: always
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # MinIO (S3-compatible storage)
    minio:
        image: minio/minio:latest
        container_name: bucket-minio-prod
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        ports:
            - '127.0.0.1:9000:9000'
            - '127.0.0.1:9001:9001'
        volumes:
            - minio_data_prod:/minio_data
        command: minio server /minio_data --console-address ":9001"
        healthcheck:
            test:
                ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
            interval: 30s
            timeout: 20s
            retries: 3
        networks:
            - bucket-network-prod
        restart: always
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # NestJS Application
    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: bucket-app-prod
        depends_on:
            postgres:
                condition: service_healthy
            minio:
                condition: service_healthy
        environment:
            # Database
            DB_HOST: postgres
            DB_PORT: 5432
            DB_USER: ${DB_USER}
            DB_PASSWORD: ${DB_PASS}
            DB_NAME: ${DB_NAME}

            # MinIO
            MINIO_ENDPOINT: minio
            MINIO_PORT: 9000
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
            MINIO_BUCKET: ${MINIO_BUCKET}
            MINIO_USE_SSL: ${MINIO_USE_SSL:-false}

            # App
            PORT: 3000
            NODE_ENV: production

            # JWT
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRATION: ${JWT_EXPIRATION}

            # Google OAuth
            GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
            GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}

            # Email
            MAIL_HOST: ${MAIL_HOST}
            MAIL_PORT: ${MAIL_PORT}
            MAIL_USER: ${MAIL_USER}
            MAIL_PASSWORD: ${MAIL_PASSWORD}
            MAIL_FROM: ${MAIL_FROM}

            # Trash
            TRASH_EXPIRE_DAYS: ${TRASH_EXPIRE_DAYS}
        ports:
            - '127.0.0.1:3000:3000'
        networks:
            - bucket-network-prod
        restart: always
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

volumes:
    postgres_data_prod:
        driver: local
    minio_data_prod:
        driver: local

networks:
    bucket-network-prod:
        driver: bridge
